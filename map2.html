<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Teya Merchant Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 90vh; width: 100%; }
    #controls {
      padding: 10px;
      background: #f8f8f8;
      border-bottom: 1px solid #ccc;
    }
  </style>
</head>
<body>

<div id="controls">
 <!-- <input type="file" id="csv-file" accept=".csv" /> -->
 <!-- <label for="filter">Merchant Type:</label>
  <select id="type-filter">
    <option value="">All</option>
  </select> -->
  <div style="padding: 10px;">
  <label for="type-filter">Filter by Type:</label>
  <select id="type-filter">
    <option value="">All Types</option>
  </select>

  <label for="subtype-filter" style="margin-left: 20px;">Filter by Sub-Type:</label>
  <select id="subtype-filter">
    <option value="">All Sub-Types</option>
  </select>
  </div>
</div>

<div id="map"></div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  let allData = [];
  let markers = [];

  const map = L.map('map').setView([54.5, -3], 6.5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 18,
  }).addTo(map);

  function buildMap(data) {
    // Clear existing markers
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    data.forEach(item => {
      if (item.Latitude && item.Longitude) {
        const marker = L.marker([parseFloat(item.Latitude), parseFloat(item.Longitude)]);
        marker.bindPopup(`<strong>${item.Name}</strong><br>${item.Type} - ${item.SubType}`);
        marker.addTo(map);
        markers.push(marker);
      }
    });
  }

  function populateFilterOptions(data) {
    const typeFilter = document.getElementById('type-filter');
    const subTypeFilter = document.getElementById('subtype-filter');

    const types = [...new Set(data.map(d => d.Type).filter(Boolean))].sort();
    const subTypes = [...new Set(data.map(d => d.SubType).filter(Boolean))].sort();

    // Populate Type dropdown
    typeFilter.innerHTML = '<option value="">All Types</option>';
    types.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      typeFilter.appendChild(option);
    });

    // Populate SubType dropdown
    subTypeFilter.innerHTML = '<option value="">All Sub-Types</option>';
    subTypes.forEach(Category => {
      const option = document.createElement('option');
      option.value = Category;
      option.textContent = Category;
      subTypeFilter.appendChild(option);
    });
  }

  function applyFilters() {
    const typeValue = document.getElementById('type-filter').value;
    const subTypeValue = document.getElementById('subtype-filter').value;

    const filteredData = allData.filter(item => {
      return (!typeValue || item.Type === typeValue) &&
             (!subTypeValue || item.Category === subTypeValue);
    });

    buildMap(filteredData);
  }

  // Load CSV from GitHub automatically
  Papa.parse('https://robertogdenteya.github.io/member-map/TeyaMapTest.csv', {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function (results) {
      allData = results.data;
      populateFilterOptions(allData);
      buildMap(allData);
    }
  });

  // Event listeners
  document.getElementById('type-filter').addEventListener('change', applyFilters);
  document.getElementById('subtype-filter').addEventListener('change', applyFilters);
</script>




</body>
</html>
